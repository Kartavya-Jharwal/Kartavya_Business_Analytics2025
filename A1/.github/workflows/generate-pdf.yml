name: Generate PDF Report

on:
  push:
    branches: [ main ]
    # keep the path filter so the workflow is eligible, but only run the job
    # when assignment.ipynb was added or modified in the head commit (avoids running
    # for unrelated commits). Workflow can still be manually dispatched.
    paths:
      - 'A1/assignment.ipynb'
      - 'A1/templates/**'
      - '.github/workflows/generate-pdf.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'A1/assignment.ipynb'
  workflow_dispatch:  # Allow manual trigger

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
      
    # Only run the job automatically if the head commit added/modified the notebook.
    # This avoids the job running on every push that doesn't touch the notebook.
    # Manual dispatch and PR events are still allowed.
    - name: Determine whether to continue
      id: check_changes
      run: |
        echo "head_event=${{ github.event_name }}" > check_change.txt
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "continue=true" > continue.txt
          exit 0
        fi
        # For push events, inspect the head commit added/modified files
        if [ "${{ github.event_name }}" = "push" ]; then
          ADDED="${{ toJson(github.event.head_commit.added) }}"
          MODIFIED="${{ toJson(github.event.head_commit.modified) }}"
          echo "added=$ADDED" > added.txt
          echo "modified=$MODIFIED" > modified.txt
          echo "$ADDED $MODIFIED" | grep -q 'A1/assignment.ipynb' && echo "continue=true" > continue.txt || echo "continue=false" > continue.txt
        else
          echo "continue=true" > continue.txt
        fi
        cat continue.txt

    - name: Stop job if notebook not changed
      if: ${{ always() && steps.check_changes.outputs == '' }}
      run: |
        # If continue.txt exists and contains false, exit with a special code to skip
        if [ -f continue.txt ]; then
          CONT=$(cat continue.txt)
          if [ "$CONT" = "continue=false" ]; then
            echo "No notebook change detected in head commit — skipping PDF generation.";
            exit 0
          fi
        fi
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Cache pip downloads
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('A1/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install UV
      uses: astral-sh/setup-uv@v3

    - name: Install Python dependencies (uv sync)
      working-directory: A1
      run: |
        uv sync

    - name: Install Pandoc (action)
      uses: jgm/pandoc-action@v2
      with:
        pandoc-version: '3.1.7'

    - name: Cache pandoc directory
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/bin/pandoc
          ~/.local/share/pandoc
        key: ${{ runner.os }}-pandoc-${{ hashFiles('A1/templates/**') }}
        restore-keys: |
          ${{ runner.os }}-pandoc-

    - name: Install minimal system dependency (wkhtmltopdf fallback)
      run: |
        sudo apt-get update
        sudo apt-get install -y wkhtmltopdf || true
          
    - name: Generate HTML report
      working-directory: A1
      run: |
        uv run jupyter nbconvert \
          --to html \
          --template templates/custom_report.tpl \
          --output-dir outputs \
          --output assignment_report.html \
          assignment.ipynb
          
    - name: Generate PDF from HTML
      working-directory: A1
      run: |
        set -o pipefail
        # Prefer nbconvert webpdf (requires playwright/pyppeteer); fallback to wkhtmltopdf
        uv run jupyter nbconvert \
          --to webpdf \
          --template templates/custom_report.tpl \
          --output-dir outputs \
          --output assignment_report.pdf \
          assignment.ipynb || (
            echo "webpdf failed — falling back to wkhtmltopdf";
            wkhtmltopdf \
              --enable-local-file-access \
              --page-size A4 \
              --margin-top 15mm \
              --margin-bottom 15mm \
              --margin-left 15mm \
              --margin-right 15mm \
              outputs/assignment_report.html \
              outputs/assignment_report.pdf
          )
          
    - name: Upload HTML artifact
      uses: actions/upload-artifact@v4
      with:
        name: assignment-report-html
        path: A1/outputs/assignment_report.html
        retention-days: 90
        
    - name: Upload PDF artifact
      uses: actions/upload-artifact@v4
      with:
        name: assignment-report-pdf
        path: A1/outputs/assignment_report.pdf
        retention-days: 90
        
    - name: Create outputs directory for release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: mkdir -p release-outputs
      
    - name: Copy files for release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        cp A1/outputs/assignment_report.html release-outputs/
        cp A1/outputs/assignment_report.pdf release-outputs/
        
    - name: Generate timestamp
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      id: timestamp
      run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
      
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: report-${{ steps.timestamp.outputs.date }}
        name: Assignment Report ${{ steps.timestamp.outputs.date }}
        body: |
          Automated PDF and HTML report generation from assignment.ipynb
          
          **Generated:** ${{ steps.timestamp.outputs.date }}
          **Commit:** ${{ github.sha }}
          
          ### Downloads:
          - 📄 **assignment_report.pdf** - PDF version with beautiful styling
          - 🌐 **assignment_report.html** - Interactive HTML version
        files: |
          release-outputs/assignment_report.pdf
          release-outputs/assignment_report.html
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
